# Open-LLM-VTuber ç³»ç»Ÿæ¶æ„äº¤æ¥æ–‡æ¡£

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£ä¸º Open-LLM-VTuber é¡¹ç›®çš„æ ¸å¿ƒæ¨¡å—äº¤æ¥æ–‡æ¡£ï¼Œæ¶µç›–ä»¥ä¸‹å…­ä¸ªå…³é”®æ¨¡å—ï¼š

1. **multi_user** - å¤šç”¨æˆ·åŒºåˆ†ä¸ä¼šè¯ç®¡ç†
2. **tools** - å¤§æ¨¡å‹ Function Calling å·¥å…·ç³»ç»Ÿ
3. **database** - æ•°æ®åº“ç®¡ç†ï¼ˆPostgreSQL + Redisï¼‰
4. **emotion_system** - æƒ…ç»ªä¸å¥½æ„Ÿåº¦ç³»ç»Ÿ
5. **important** - è®°å¿†ä¸çŸ¥è¯†å›¾è°±ç³»ç»Ÿ
6. **utils** - è®¡è´¹ä¸æˆæœ¬è¿½è¸ªç³»ç»Ÿ

---

## 1. Multi_User æ¨¡å— - å¤šç”¨æˆ·åŒºåˆ†ä¸ä¼šè¯ç®¡ç†

### ğŸ“‚ æ¨¡å—ä½ç½®
```
Open-LLM-VTuber/src/ling_engine/multi_user/
```

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
å®ç°å¤šç”¨æˆ·ç‹¬ç«‹çŠ¶æ€éš”ç¦»ï¼Œæ”¯æŒå¤šä¸ªç”¨æˆ·åŒæ—¶ä¸AIè¿›è¡Œç‹¬ç«‹å¯¹è¯ï¼Œç¡®ä¿ç”¨æˆ·é—´æ•°æ®ä¸æ··æ·†ã€‚

### ğŸ“ æ ¸å¿ƒæ–‡ä»¶

#### 1.1 `user_session_manager.py` - ç”¨æˆ·ä¼šè¯ç®¡ç†å™¨
**ä¸»è¦èŒè´£ï¼š**
- ç®¡ç† WebSocket è¿æ¥ä¸ç”¨æˆ·èº«ä»½æ˜ å°„
- æ”¯æŒå¤šç§ç”¨æˆ·èº«ä»½è¯†åˆ«æ–¹å¼ï¼ˆæŸ¥è¯¢å‚æ•°ã€Cookieã€Headerï¼‰
- ç»´æŠ¤å®¢æˆ·ç«¯ä¸ç”¨æˆ·çš„åŒå‘æ˜ å°„å…³ç³»

**æ ¸å¿ƒç±»ï¼š** `UserSessionManager`

**å…³é”®æ–¹æ³•ï¼š**
- `extract_user_identity(websocket)` - æå–ç”¨æˆ·èº«ä»½æ ‡è¯†
  - æ–¹æ³•1: æŸ¥è¯¢å‚æ•° `?user_id=alice`
  - æ–¹æ³•2: Cookie `document.cookie = "user_id=alice"`
  - æ–¹æ³•3: Header `{"X-User-ID": "alice"}`
  - æ–¹æ³•4: åŸºäºå®¢æˆ·ç«¯ä¿¡æ¯ç”Ÿæˆä¸´æ—¶ ID

- `register_connection(websocket, client_uid, user_id)` - æ³¨å†Œè¿æ¥
- `get_user_state_by_client(client_uid)` - è·å–ç”¨æˆ·çŠ¶æ€
- `disconnect_client(client_uid)` - æ–­å¼€è¿æ¥å¹¶æ¸…ç†èµ„æº
- `get_session_stats()` - è·å–ä¼šè¯ç»Ÿè®¡ä¿¡æ¯

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
session_manager = UserSessionManager()
user_id = await session_manager.extract_user_identity(websocket)
user_state = session_manager.register_connection(websocket, client_uid, user_id)
```

#### 1.2 `user_state.py` - ç”¨æˆ·çŠ¶æ€ç®¡ç†
**ä¸»è¦èŒè´£ï¼š**
- å®ç°ç”¨æˆ·ID + ä¼šè¯IDçš„åŒé‡éš”ç¦»æœºåˆ¶
- ç®¡ç†å¯¹è¯å†å²ã€è®°å¿†ä¸Šä¸‹æ–‡ã€æƒ…æ„ŸçŠ¶æ€

**æ ¸å¿ƒç±»ï¼š**
- `ConversationSession` (åˆ«å `UserState`) - å¯¹è¯ä¼šè¯çŠ¶æ€å®¹å™¨
- `SessionManager` (åˆ«å `UserStateManager`) - ä¼šè¯ç®¡ç†å™¨

**ConversationSession æ ¸å¿ƒå±æ€§ï¼š**
```python
{
    "user_id": str,              # ç”¨æˆ·ID
    "session_id": str,           # ä¼šè¯ID
    "client_uid": str,           # å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†
    "history_uid": str,          # å†å²è®°å½•å”¯ä¸€æ ‡è¯†
    "conversation_history": [],  # å¯¹è¯å†å²
    "memory_context": {},        # è®°å¿†ä¸Šä¸‹æ–‡
    "emotion_state": {},         # æƒ…æ„ŸçŠ¶æ€
    "last_interaction": datetime,
    "connection_time": datetime
}
```

**å…³é”®æ–¹æ³•ï¼š**
- `create_session(user_id, session_id, client_uid)` - åˆ›å»ºä¼šè¯
- `get_session(user_id, session_id, client_uid)` - è·å–ä¼šè¯
- `add_conversation(role, content, metadata)` - æ·»åŠ å¯¹è¯è®°å½•
- `update_memory(key, value)` - æ›´æ–°è®°å¿†ä¸Šä¸‹æ–‡
- `cleanup_inactive_sessions(inactive_minutes)` - æ¸…ç†ä¸æ´»è·ƒä¼šè¯

#### 1.3 `user_aware_agent.py` - ç”¨æˆ·æ„ŸçŸ¥ Agent åŒ…è£…å™¨
**ä¸»è¦èŒè´£ï¼š**
- ä¸ºç°æœ‰ Agent æ·»åŠ å¤šç”¨æˆ·çŠ¶æ€éš”ç¦»èƒ½åŠ›
- è‡ªåŠ¨ç®¡ç†ç”¨æˆ·ä¸Šä¸‹æ–‡åˆ‡æ¢

**æ ¸å¿ƒç±»ï¼š** `UserAwareAgentWrapper`

**å…³é”®æ–¹æ³•ï¼š**
- `switch_to_user(user_id, user_state)` - åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·ä¸Šä¸‹æ–‡
- `get_response(user_input, user_id, user_state)` - è·å–å“åº”ï¼ˆè‡ªåŠ¨åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼‰
- `clear_user_context(user_id)` - æ¸…ç†ç”¨æˆ·ä¸Šä¸‹æ–‡

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
wrapped_agent = UserAwareAgentWrapper(base_agent)
response = await wrapped_agent.get_response(
    user_input="ä½ å¥½",
    user_id="alice",
    user_state=user_state
)
```

### ğŸ”‘ å…³é”®è®¾è®¡æ¨¡å¼
1. **åŒé‡éš”ç¦»æœºåˆ¶**ï¼š`user_id:session_id` ç¡®ä¿åŒä¸€ç”¨æˆ·çš„ä¸åŒä¼šè¯ä¹Ÿèƒ½éš”ç¦»
2. **WebSocket æ˜ å°„**ï¼šç»´æŠ¤ `websocket â†” client_uid` å’Œ `client_uid â†” user_id` åŒå‘æ˜ å°„
3. **çŠ¶æ€ä¿å­˜ä¸æ¢å¤**ï¼šAgent åœ¨ç”¨æˆ·åˆ‡æ¢æ—¶è‡ªåŠ¨ä¿å­˜/æ¢å¤çŠ¶æ€

### âš ï¸ æ³¨æ„äº‹é¡¹
- ç”¨æˆ·èº«ä»½æå–ä¼˜å…ˆçº§ï¼šæŸ¥è¯¢å‚æ•° > Cookie > Header > è‡ªåŠ¨ç”Ÿæˆ
- ä¼šè¯è¶…æ—¶æ¸…ç†é»˜è®¤ 30 åˆ†é’Ÿ
- æ¯ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªå¹¶å‘ä¼šè¯

---

## 2. Tools æ¨¡å— - Function Calling å·¥å…·ç³»ç»Ÿ

### ğŸ“‚ æ¨¡å—ä½ç½®
```
Open-LLM-VTuber/src/ling_engine/tools/
```

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
æä¾›å¯æ‰©å±•çš„å·¥å…·æ¡†æ¶ï¼Œæ”¯æŒå¤§æ¨¡å‹è¿›è¡Œ Function Callingï¼Œé›†æˆ LangChain å·¥å…·ç”Ÿæ€ã€‚

### ğŸ“ æ ¸å¿ƒæ–‡ä»¶

#### 2.1 `base_tool.py` - åŸºç¡€å·¥å…·æ¡†æ¶
**æ ¸å¿ƒç±»ï¼š**
- `BaseTool` - å·¥å…·æŠ½è±¡åŸºç±»
- `ToolRegistry` - å·¥å…·æ³¨å†Œè¡¨

**BaseTool æ¥å£ï¼š**
```python
class BaseTool(ABC):
    def __init__(self, name: str, description: str):
        self.name = name
        self.description = description

    @abstractmethod
    async def execute(self, **kwargs) -> str:
        """æ‰§è¡Œå·¥å…·æ ¸å¿ƒé€»è¾‘"""
        pass

    def validate_params(self, params, required_params) -> bool:
        """éªŒè¯å‚æ•°å®Œæ•´æ€§"""
        pass

    def create_langchain_tool(self):
        """åˆ›å»º LangChain å·¥å…·å®ä¾‹"""
        pass
```

**å·¥å…·æ³¨å†Œæµç¨‹ï¼š**
```python
# 1. å®šä¹‰å·¥å…·
class MyTool(BaseTool):
    async def execute(self, **kwargs):
        # å®ç°å·¥å…·é€»è¾‘
        return "result"

# 2. æ³¨å†Œå·¥å…·
tool_registry.register(MyTool("my_tool", "å·¥å…·æè¿°"))

# 3. è·å– LangChain å·¥å…·
langchain_tools = tool_registry.get_langchain_tools()
```

#### 2.2 `tool_manager.py` - å·¥å…·ç®¡ç†å™¨
**æ ¸å¿ƒç±»ï¼š** `ToolManager`

**ä¸»è¦åŠŸèƒ½ï¼š**
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å·¥å…·
- é›†æˆ MCPï¼ˆModel Context Protocolï¼‰å·¥å…·
- æä¾› LangChain å·¥å…·è½¬æ¢

**å…³é”®æ–¹æ³•ï¼š**
- `initialize()` - åˆå§‹åŒ–å·¥å…·ç®¡ç†å™¨
- `get_all_tools()` - è·å–æ‰€æœ‰å·¥å…·
- `get_langchain_tools()` - è·å– LangChain å·¥å…·åˆ—è¡¨
- `add_tools_to_mcp_list(mcp_tools)` - åˆå¹¶å†…ç½®å·¥å…·ä¸ MCP å·¥å…·

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
from src.ling_engine.tools.tool_manager import tool_manager

# åˆå§‹åŒ–
tool_manager.initialize()

# è·å–æ‰€æœ‰å·¥å…·ï¼ˆåŒ…å« MCP å·¥å…·ï¼‰
combined_tools = tool_manager.add_tools_to_mcp_list(mcp_tools)

# ä¼ é€’ç»™ Agent
agent = create_react_agent(llm, combined_tools)
```

### ğŸ”§ æ‰©å±•æ–°å·¥å…·

**æ­¥éª¤ï¼š**
1. ç»§æ‰¿ `BaseTool` ç±»
2. å®ç° `execute()` æ–¹æ³•
3. æ³¨å†Œåˆ° `tool_registry`
4. å·¥å…·ä¼šè‡ªåŠ¨è½¬æ¢ä¸º LangChain æ ¼å¼

**ç¤ºä¾‹ï¼š**
```python
# memory_tools.py
from .base_tool import BaseTool, tool_registry

class SearchMemoryTool(BaseTool):
    async def execute(self, query: str, **kwargs) -> str:
        # å®ç°è®°å¿†æœç´¢é€»è¾‘
        results = await search_memories(query)
        return json.dumps(results)

# è‡ªåŠ¨æ³¨å†Œ
tool_registry.register(SearchMemoryTool(
    name="search_similar_memories",
    description="æœç´¢ç›¸ä¼¼çš„è®°å¿†å†…å®¹"
))
```

### ğŸ”‘ å…³é”®è®¾è®¡æ¨¡å¼
1. **æ³¨å†Œè¡¨æ¨¡å¼**ï¼šé›†ä¸­ç®¡ç†æ‰€æœ‰å·¥å…·
2. **å·¥å‚æ¨¡å¼**ï¼šè‡ªåŠ¨åˆ›å»º LangChain å·¥å…·
3. **è£…é¥°å™¨æ¨¡å¼**ï¼š`@tool` è£…é¥°å™¨è½¬æ¢

---

## 3. Database æ¨¡å— - æ•°æ®åº“ç®¡ç†

### ğŸ“‚ æ¨¡å—ä½ç½®
```
Open-LLM-VTuber/src/ling_engine/database/
â”œâ”€â”€ pgsql/          # PostgreSQL ç›¸å…³
â””â”€â”€ redis/          # Redis ç›¸å…³
```

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
æä¾›æ•°æ®åº“è¿æ¥ç®¡ç†ã€ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯ç®¡ç†ï¼Œæ”¯æŒ Redis ç¼“å­˜å±‚ã€‚

### ğŸ“ æ ¸å¿ƒæ–‡ä»¶

#### 3.1 `pgsql/database_manager.py` - PostgreSQL ç®¡ç†å™¨

**æ ¸å¿ƒç±»ï¼š**

1. **`SnowflakeIDGenerator`** - Snowflake ID ç”Ÿæˆå™¨
```python
# 64ä½IDç»„æˆ: 1ç¬¦å·ä½ | 41ä½æ¯«ç§’æ—¶é—´æˆ³ | 5ä½æ•°æ®ä¸­å¿ƒ | 5ä½å·¥ä½œèŠ‚ç‚¹ | 12ä½è‡ªå¢åºåˆ—
id_generator = SnowflakeIDGenerator(datacenter_id=1, worker_id=1)
unique_id = id_generator.generate_id()
```

2. **`DatabaseManager`** - æ•°æ®åº“è¿æ¥æ± ç®¡ç†
```python
db_manager = DatabaseManager(
    host='localhost',
    port=5432,
    user='postgres',
    password='password',
    database='vtuber_chat_db',
    min_conn=1,
    max_conn=10
)
db_manager.connect()
conn = db_manager.get_connection()
```

3. **`ChatSessionManager`** - èŠå¤©ä¼šè¯ç®¡ç†
**ä¸»è¦æ–¹æ³•ï¼š**
- `create_session(session_id, user_id, character_name)` - åˆ›å»ºä¼šè¯
- `get_session(session_id)` - è·å–ä¼šè¯
- `get_user_sessions(user_id)` - è·å–ç”¨æˆ·æ‰€æœ‰ä¼šè¯
- `update_session(session_id, **kwargs)` - æ›´æ–°ä¼šè¯ä¿¡æ¯
- `pin_session(session_id, is_pinned)` - ç½®é¡¶ä¼šè¯
- `rename_session(session_id, custom_title)` - é‡å‘½åä¼šè¯
- `delete_session(session_id)` - è½¯åˆ é™¤ä¼šè¯

4. **`ChatMessageManager`** - èŠå¤©æ¶ˆæ¯ç®¡ç†
**ä¸»è¦æ–¹æ³•ï¼š**
- `add_message(session_id, role, content)` - æ·»åŠ æ¶ˆæ¯
- `get_session_messages(session_id, limit)` - è·å–ä¼šè¯æ¶ˆæ¯
- `delete_message(message_id)` - è½¯åˆ é™¤æ¶ˆæ¯

**å…¨å±€å®ä¾‹è·å–ï¼š**
```python
from src.ling_engine.database.pgsql.database_manager import (
    get_db_manager,
    get_session_manager,
    get_message_manager
)

db_manager = get_db_manager()
session_manager = get_session_manager()
message_manager = get_message_manager()
```

#### 3.2 `redis/redis_manager.py` - Redis ç®¡ç†å™¨

**æ ¸å¿ƒç±»ï¼š** `RedisManager`

**ä¸»è¦åŠŸèƒ½ï¼š**
- Redis è¿æ¥ç®¡ç†
- JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
- List æ“ä½œåŠ©æ‰‹

**å…³é”®æ–¹æ³•ï¼š**
```python
redis_manager = RedisManager(
    host='localhost',
    port=6379,
    db=0,
    namespace='vtuber'
)

# JSON æ“ä½œ
redis_manager.set_json(key, value, ex=3600)
data = redis_manager.get_json(key)

# List æ“ä½œ
redis_manager.rpush_json(key, [item1, item2])
items = redis_manager.lrange_json(key, 0, -1)

# é”®ç®¡ç†
redis_manager.delete(key1, key2)
redis_manager.expire(key, ttl_seconds)
```

**å‘½åç©ºé—´æœºåˆ¶ï¼š**
```python
# è‡ªåŠ¨æ·»åŠ å‘½åç©ºé—´å‰ç¼€
redis_manager._k("session", "123")  # â†’ "vtuber:session:123"
```

#### 3.3 `pgsql/cache_backed_managers.py` - ç¼“å­˜å±‚
æä¾›å¸¦ Redis ç¼“å­˜çš„ä¼šè¯å’Œæ¶ˆæ¯ç®¡ç†å™¨ï¼š
- `CacheBackedChatSessionManager`
- `CacheBackedChatMessageManager`

**ç¼“å­˜ç­–ç•¥ï¼š**
- è¯»å–ï¼šä¼˜å…ˆ Redis â†’ é™çº§åˆ° PostgreSQL
- å†™å…¥ï¼šåŒæ—¶å†™å…¥ PostgreSQL å’Œ Redis
- å¤±æ•ˆï¼šTTL è¿‡æœŸ + æ‰‹åŠ¨æ¸…é™¤

### ğŸ—ƒï¸ æ•°æ®åº“è¡¨ç»“æ„

**chat_sessions è¡¨ï¼š**
```sql
CREATE TABLE chat_sessions (
    id BIGINT PRIMARY KEY,              -- Snowflake ID
    session_id VARCHAR(255) UNIQUE,     -- ä¼šè¯ID
    user_id VARCHAR(255),               -- ç”¨æˆ·ID
    character_name VARCHAR(255),        -- è§’è‰²åç§°
    session_name VARCHAR(255),          -- ä¼šè¯åç§°
    custom_title VARCHAR(255),          -- è‡ªå®šä¹‰æ ‡é¢˜
    is_pinned BOOLEAN DEFAULT FALSE,    -- æ˜¯å¦ç½®é¡¶
    deleted BOOLEAN DEFAULT FALSE,      -- è½¯åˆ é™¤æ ‡è®°
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**chat_messages è¡¨ï¼š**
```sql
CREATE TABLE chat_messages (
    id BIGINT PRIMARY KEY,              -- Snowflake ID
    session_id VARCHAR(255),            -- ä¼šè¯ID
    role VARCHAR(50),                   -- è§’è‰²ï¼ˆuser/assistantï¼‰
    content TEXT,                       -- æ¶ˆæ¯å†…å®¹
    deleted BOOLEAN DEFAULT FALSE,      -- è½¯åˆ é™¤æ ‡è®°
    created_at TIMESTAMP DEFAULT NOW()
);
```

### âš™ï¸ é…ç½®ç®¡ç†
æ”¯æŒä»é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡è¯»å–ï¼š
```python
# ä¼˜å…ˆçº§ï¼šç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
host = os.getenv('PGHOST') or config.postgres.host
```

---

## 4. Emotion_System æ¨¡å— - æƒ…ç»ªä¸å¥½æ„Ÿåº¦ç³»ç»Ÿ

### ğŸ“‚ æ¨¡å—ä½ç½®
```
Open-LLM-VTuber/src/ling_engine/emotion_system/
```

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
å®ç°æƒ…ç»ªåˆ†æã€å¥½æ„Ÿåº¦ç®¡ç†ã€Live2D è¡¨æƒ…/åŠ¨ä½œæ§åˆ¶ã€‚

### ğŸ“ æ ¸å¿ƒæ–‡ä»¶

#### 4.1 `emotion_manager.py` - æƒ…ç»ªç®¡ç†å™¨

**æ ¸å¿ƒç±»ï¼š**
- `EmotionConfig` - æƒ…ç»ªç³»ç»Ÿé…ç½®
- `EmotionManager` - æƒ…ç»ªç®¡ç†å™¨

**EmotionConfig é…ç½®é¡¹ï¼š**
```python
{
    "default_affinity": 50,        # åˆå§‹å¥½æ„Ÿåº¦
    "sensitivity": 1.0,            # å¥½æ„Ÿåº¦å˜åŒ–æ•æ„Ÿåº¦
    "affinity_levels": {           # å¥½æ„Ÿåº¦ç­‰çº§
        "hatred": {"threshold": 10, "prompt": "..."},
        "hostile": {"threshold": 20, "prompt": "..."},
        "indifferent": {"threshold": 35, "prompt": "..."},
        "neutral": {"threshold": 50, "prompt": "..."},
        "friendly": {"threshold": 65, "prompt": "..."},
        "close": {"threshold": 80, "prompt": "..."},
        "devoted": {"threshold": 90, "prompt": "..."}
    },
    "milestones": [25, 50, 75, 90], # é‡Œç¨‹ç¢‘
    "expression_weights": {...}     # è¡¨æƒ…æƒé‡
}
```

**EmotionManager æ ¸å¿ƒæ–¹æ³•ï¼š**

1. **å¥½æ„Ÿåº¦ç®¡ç†**
```python
# è·å–å¥½æ„Ÿåº¦
affinity = emotion_manager.get_affinity(character_id, user_id)

# æ›´æ–°å¥½æ„Ÿåº¦
new_affinity = await emotion_manager.update_affinity(
    character_id,
    user_id,
    message,
    role  # "human" or "ai"
)

# è·å–å¥½æ„Ÿåº¦ç­‰çº§
level = emotion_manager.get_affinity_level(affinity)
```

2. **æƒ…ç»ªæç¤ºç”Ÿæˆ**
```python
# æ ¹æ®å¥½æ„Ÿåº¦ç”Ÿæˆæƒ…ç»ªæç¤º
emotion_prompt = emotion_manager.get_emotion_prompt(affinity)
# è¾“å‡º: "You are an extremely arrogant and cold young lady..."

# è·å–æ€§æ ¼ç‰¹å¾
traits = emotion_manager.get_personality_traits(affinity)
# è¾“å‡º: ["arrogant", "cold", "disdainful", "young lady"]
```

3. **Live2D æ§åˆ¶**
```python
# è®¾ç½® WebSocket å’Œ Live2D æ¨¡å‹
emotion_manager.set_websocket(websocket)
emotion_manager.set_live2d_model(live2d_model)

# æ’­æ”¾è¡¨æƒ…åŠ¨ä½œåºåˆ—
await emotion_manager.play_emotion_playlist("happy")

# æ›´æ–°è¡¨æƒ…å’ŒåŠ¨ä½œï¼ˆè‡ªåŠ¨ï¼‰
# åœ¨ update_affinity æ—¶è‡ªåŠ¨è§¦å‘
```

**å¥½æ„Ÿåº¦å˜åŒ–é€»è¾‘ï¼š**
```python
# ç”¨æˆ·æ¶ˆæ¯
if role == "human":
    base_change = analysis.affinity_change

    # ä½å¥½æ„Ÿåº¦æ—¶å¯¹ç§¯æåé¦ˆæ›´æ•æ„Ÿ
    if current_affinity < 30 and sentiment == "positive":
        base_change *= 1.5

    # é«˜å¥½æ„Ÿåº¦æ—¶å¯¹æ¶ˆæåé¦ˆæ›´æŠµæŠ—
    elif current_affinity > 70 and sentiment == "negative":
        base_change *= 0.7

    change = int(base_change * sensitivity)

# AIå›å¤
else:
    if sentiment == "positive":
        if "sad" in message: change = -2
        elif "angry" in message: change = -3
        else: change = 2
    elif sentiment == "negative":
        change = -2
    else:
        change = 0
```

#### 4.2 `emotional_agent.py` - æƒ…ç»ªåŒ– Agent

**æ ¸å¿ƒç±»ï¼š** `EmotionalBasicMemoryAgent` (ç»§æ‰¿è‡ª `BasicMemoryAgent`)

**ä¸»è¦åŠŸèƒ½ï¼š**
- åœ¨å¯¹è¯å‰åè‡ªåŠ¨æ›´æ–°å¥½æ„Ÿåº¦
- æ ¹æ®å¥½æ„Ÿåº¦åŠ¨æ€è°ƒæ•´ç³»ç»Ÿæç¤ºè¯
- é›†æˆæƒ…ç»ªåˆ†æåˆ°å¯¹è¯æµç¨‹

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
emotional_agent = EmotionalBasicMemoryAgent(
    llm=llm,
    system=system_prompt,
    live2d_model=live2d_model,
    emotion_manager=emotion_manager
)

# è®¾ç½®è®°å¿†å’Œç”¨æˆ·èº«ä»½
emotional_agent.set_memory_from_history(conf_uid, history_uid)

# æ­£å¸¸è°ƒç”¨ï¼Œæƒ…ç»ªç³»ç»Ÿè‡ªåŠ¨å·¥ä½œ
response = await emotional_agent.chat(user_input)
```

#### 4.3 `emotion_analyzer.py` - æƒ…ç»ªåˆ†æå™¨
ä½¿ç”¨ LLM åˆ†ææ–‡æœ¬æƒ…ç»ªï¼š
- æƒ…æ„Ÿç±»å‹ï¼ˆpositive/negative/neutralï¼‰
- æƒ…æ„Ÿå¼ºåº¦ï¼ˆ0.0 - 1.0ï¼‰
- å…³é”®è¯æå–
- å¥½æ„Ÿåº¦å˜åŒ–å»ºè®®

#### 4.4 `expression_manager.py` - è¡¨æƒ…ç®¡ç†å™¨
æ ¹æ®æƒ…ç»ªå’Œå¥½æ„Ÿåº¦é€‰æ‹©åˆé€‚çš„ Live2D è¡¨æƒ…ã€‚

#### 4.5 `websocket_notifier.py` - WebSocket é€šçŸ¥å™¨
é€šè¿‡ WebSocket å‘é€ï¼š
- å¥½æ„Ÿåº¦æ›´æ–°
- é‡Œç¨‹ç¢‘è¾¾æˆ
- æƒ…ç»ªè¡¨æƒ…å˜åŒ–

### ğŸ­ Live2D é›†æˆ

**è¡¨æƒ…æ˜ å°„ç¤ºä¾‹ï¼š**
```python
live2d_model.emo_map = {
    "happy": 0,
    "sad": 1,
    "angry": 2,
    "surprised": 3,
    # ...
}
```

**åŠ¨ä½œç»„è§¦å‘ï¼š**
```python
# æ ¹æ®æƒ…æ„Ÿå’Œå¼ºåº¦è§¦å‘åŠ¨ä½œ
if sentiment == "positive" and intensity > 0.7:
    motion_group = "Happy"
elif sentiment == "negative" and intensity > 0.7:
    motion_group = "Sad"

payload = live2d_model.play_motion_group(motion_group)
await websocket.send_text(json.dumps(payload))
```

### ğŸ“Š æƒ…ç»ªæ—¥å¿—è¾“å‡º
æ§åˆ¶å°å®æ—¶æ˜¾ç¤ºï¼š
```
================================================================================
ğŸ­ [Emotion Analysis and Affinity Change] 14:32:15
================================================================================
ğŸ‘¤ Character: vtuber | User: alice
ğŸ’¬ Message: ä½ å¥½å‘€ï¼Œä»Šå¤©å¤©æ°”çœŸå¥½ï¼
ğŸ“ Sender: human
ğŸ˜Š Sentiment: positive | Intensity: 0.75
ğŸ·ï¸ Keywords: é—®å€™, ç§¯æ, å¤©æ°”
ğŸ“ˆ Affinity Increased: 50 â†’ 52 (+2)
ğŸ’– Current Level: neutral
================================================================================
```

### ğŸ”‘ å…³é”®è®¾è®¡æ¨¡å¼
1. **çŠ¶æ€æœºæ¨¡å¼**ï¼šå¥½æ„Ÿåº¦ç­‰çº§è½¬æ¢
2. **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šWebSocket é€šçŸ¥
3. **ç­–ç•¥æ¨¡å¼**ï¼šä¸åŒå¥½æ„Ÿåº¦çš„æƒ…ç»ªå“åº”ç­–ç•¥

---

## 5. Important æ¨¡å— - è®°å¿†ä¸çŸ¥è¯†å›¾è°±ç³»ç»Ÿ

### ğŸ“‚ æ¨¡å—ä½ç½®
```
Open-LLM-VTuber/src/ling_engine/important/
```

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
å®ç°æ™ºèƒ½è®°å¿†ç³»ç»Ÿï¼Œç»“åˆå‘é‡æ£€ç´¢ï¼ˆQdrantï¼‰å’ŒçŸ¥è¯†å›¾è°±ï¼ˆNeo4jï¼‰ã€‚

### ğŸ“ æ ¸å¿ƒæ–‡ä»¶

#### 5.1 `important.py` - é‡è¦æ€§è¯„ä¼°

**æ ¸å¿ƒå‡½æ•°ï¼š** `process_content(content)`

**åŠŸèƒ½ï¼š**
1. åˆ¤æ–­å†…å®¹æ˜¯å¦é‡è¦
2. ç”Ÿæˆæ€»ç»“
3. è¯„ä¼°æƒé‡ï¼ˆ1-10ï¼‰
4. æå–ä¸‰å…ƒç»„ï¼ˆä¸»ä½“ã€åŠ¨ä½œã€å®¢ä½“ï¼‰
5. å¯¹å®¾è¯­åˆ†ç±»
6. æ ‡è®°å”¯ä¸€æ€§

**è¿”å›å€¼ï¼š**
```python
(
    is_important: bool,
    summary: str,
    weight: int,
    categorized_triples: List[
        [subject, predicate, object, category, is_unique]
    ]
)
```

**é‡è¦å†…å®¹åˆ¤æ–­æ ‡å‡†ï¼š**
1. ç”¨æˆ·çš„ä¸ªäººè®¡åˆ’å’Œå®‰æ’
2. ç”¨æˆ·çš„é‡è¦å†³å®šå’Œæƒ³æ³•
3. éœ€è¦åç»­è·Ÿè¿›çš„äº‹é¡¹
4. æœ‰ä»·å€¼çš„ä¿¡æ¯å’Œå­¦ä¹ è¦ç‚¹
5. ç”¨æˆ·ä¸AIä¹‹é—´çš„é‡è¦äº’åŠ¨
6. ç‰¹æ®Šæƒ…æ„Ÿæˆ–é‡è¦äº‹ä»¶
7. ç”¨æˆ·ç§äººä¿¡æ¯ï¼ˆç”Ÿæ—¥ã€å§“åã€å®¶åº­ç­‰ï¼‰
8. ç”¨æˆ·å…´è¶£çˆ±å¥½å’Œåå¥½

**ç¤ºä¾‹ï¼š**
```python
content = "æˆ‘å–œæ¬¢æ‰“ç¾½æ¯›çƒï¼Œæ˜å¤©è®¡åˆ’å»æˆéƒ½æ—…è¡Œï¼Œé‚€è¯·å°æ˜ä¸€èµ·"

is_important, summary, weight, triples = process_content(content)

# è¾“å‡ºï¼š
# is_important = True
# summary = "ç”¨æˆ·å–œæ¬¢æ‰“ç¾½æ¯›çƒï¼Œè®¡åˆ’æ˜å¤©å»æˆéƒ½æ—…è¡Œï¼Œå¹¶é‚€è¯·å°æ˜"
# weight = 8
# triples = [
#     ["ç”¨æˆ·", "å–œæ¬¢", "æ‰“ç¾½æ¯›çƒ", "è¿åŠ¨", False],
#     ["ç”¨æˆ·", "è®¡åˆ’", "æˆéƒ½æ—…è¡Œ", "æ—…è¡Œ", False],
#     ["ç”¨æˆ·", "é‚€è¯·", "å°æ˜", "äººç‰©", False]
# ]
```

#### 5.2 `memories.py` - è®°å¿†å­˜å‚¨ä¸æ£€ç´¢

**æ ¸å¿ƒå‡½æ•°ï¼š**

1. **ä¿å­˜è®°å¿†**
```python
save_memory(content, user_id) -> bool
```
æµç¨‹ï¼š
- è°ƒç”¨ `process_content` åˆ¤æ–­é‡è¦æ€§
- ç”ŸæˆåµŒå…¥å‘é‡ (OpenAI Embedding)
- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸ä¼¼è®°å¿†
- ä¿å­˜åˆ° Qdrantï¼ˆå‘é‡æ•°æ®åº“ï¼‰
- ä¿å­˜åˆ° Neo4jï¼ˆçŸ¥è¯†å›¾è°±ï¼‰

2. **æœç´¢è®°å¿†**
```python
search_similar_memories(query, user_id, limit=5) -> List[Tuple]
```
**æ··åˆæ£€ç´¢ç­–ç•¥ï¼š**
- Qdrant å‘é‡æœç´¢ï¼š60% æƒé‡
- Neo4j ä¸‰å…ƒç»„æœç´¢ï¼š40% æƒé‡
- ç»¼åˆæ’åºå› å­ï¼š
  - æ—¶é—´å› å­ï¼š15%
  - æƒé‡å› å­ï¼š35%
  - å‘é‡ç›¸å…³æ€§ï¼š25%
  - ä¸‰å…ƒç»„æ•°é‡ï¼š25%

3. **çŸ¥è¯†å›¾è°±æŸ¥è¯¢**
```python
# æŸ¥è¯¢ç”¨æˆ·çŸ¥è¯†å›¾è°±
get_user_knowledge_graph(subject, predicate, category)

# æŸ¥è¯¢çŸ¥è¯†ä¸‰å…ƒç»„
query_knowledge_triple(subject, predicate, category, user_id)

# æœç´¢ç”¨æˆ·åå¥½
search_user_preferences(user_id, predicate, category, limit)

# æ··åˆæœç´¢ï¼ˆå‘é‡+å›¾è°±ï¼‰
hybrid_search(query, user_id, limit)
```

4. **è®°å¿†ç®¡ç†**
```python
# åˆ é™¤è®°å¿†ï¼ˆé€»è¾‘åˆ é™¤ï¼‰
delete_memory(memory_id, user_id) -> bool

# åˆ—å‡ºæ‰€æœ‰è®°å¿†
list_all_memories_simple(user_id, limit) -> List[Dict]
```

### ğŸ—„ï¸ æ•°æ®å­˜å‚¨æ¶æ„

#### Qdrantï¼ˆå‘é‡æ•°æ®åº“ï¼‰
```python
# æ•°æ®ç»“æ„
{
    "id": "uuid",
    "vector": [1536ç»´å‘é‡],
    "payload": {
        "summary": "è®°å¿†æ‘˜è¦",
        "weight": 8,
        "created_at": "2024-01-01T12:00:00Z",
        "updated_at": "2024-01-01T12:00:00Z",
        "user_id": "alice",
        "is_deleted": False,
        "triples": [...]
    }
}
```

#### Neo4jï¼ˆçŸ¥è¯†å›¾è°±ï¼‰
**å±‚çº§ç»“æ„ï¼š** Subject â†’ Predicate â†’ Category â†’ Object

```cypher
# èŠ‚ç‚¹ç±»å‹
(:Subject {name: "ç”¨æˆ·"})
(:Predicate {name: "å–œæ¬¢"})
(:Category {name: "è¿åŠ¨"})
(:Object {name: "æ‰“ç¾½æ¯›çƒ"})
(:Memory {id: "uuid", user_id: "alice"})

# å…³ç³»
(Subject)-[:HAS_PREDICATE {name: "å–œæ¬¢"}]->(Predicate)
(Predicate)-[:HAS_CATEGORY]->(Category)
(Category)-[:HAS_OBJECT]->(Object)
(Memory)-[:CONTAINS]->(Object)
```

**å”¯ä¸€æ€§å¤„ç†ï¼š**
å¯¹äºå”¯ä¸€å±æ€§ï¼ˆå¦‚å§“åã€å¹´é¾„ï¼‰ï¼Œæ›´æ–°æ—¶ï¼š
1. æ ‡è®°æ—§å€¼ä¸º `is_deleted = true`
2. åˆ›å»ºæ–°å€¼èŠ‚ç‚¹
3. ä¿ç•™å†å²è®°å½•

### ğŸ” æ£€ç´¢ä¼˜åŒ–

**ç›¸ä¼¼åº¦é˜ˆå€¼ï¼š**
- æ™®é€šè®°å¿†ï¼š0.85
- å”¯ä¸€å±æ€§ï¼š0.75ï¼ˆå…è®¸æ›´å®½æ¾çš„åŒ¹é…ï¼‰

**ç»¼åˆç›¸ä¼¼åº¦ï¼š**
```python
combined_similarity = 0.4 * edit_similarity + 0.6 * vector_similarity
```

**ç”¨æˆ·éš”ç¦»ï¼š**
æ‰€æœ‰æŸ¥è¯¢å’Œå­˜å‚¨éƒ½å¼ºåˆ¶æ ¡éªŒ `user_id`ï¼Œé˜²æ­¢ç”¨æˆ·é—´è®°å¿†æ··æ·†ã€‚

### ğŸ’° Token è¿½è¸ª
è‡ªåŠ¨è®°å½• Embedding å’Œ LLM è°ƒç”¨çš„ token ä½¿ç”¨ï¼š
```python
from ..utils.token_counter import token_stats

# è‡ªåŠ¨æ·»åŠ ç»Ÿè®¡
token_stats.add_usage(
    model="text-embedding-3-small",
    usage=TokenUsage(...),
    cost=0.00001,
    metadata={"service_type": "embedding"}
)
```

### âš™ï¸ é…ç½®å‚æ•°
```python
# ç¯å¢ƒå˜é‡
OPENAI_MODEL = "gpt-4o-mini"
OPENAI_EMBEDDING_MODEL = "text-embedding-3-small"
OPENAI_EMBEDDING_MODEL_DIMS = 1536
QDRANT_URL = "http://qdrant:6333"
NEO4J_URI = "bolt://neo4j:7687"
NEO4J_USERNAME = "neo4j"
NEO4J_PASSWORD = "12345678"
```

---

## 6. Utils æ¨¡å— - è®¡è´¹ä¸æˆæœ¬è¿½è¸ªç³»ç»Ÿ

### ğŸ“‚ æ¨¡å—ä½ç½®
```
Open-LLM-VTuber/src/ling_engine/utils/
```

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
æä¾›æ¨¡å‹å®šä»·ç®¡ç†ã€Token ä½¿ç”¨ç»Ÿè®¡ã€æˆæœ¬è¿½è¸ªå’ŒæŠ¥å‘Šç”Ÿæˆã€‚

### ğŸ“ æ ¸å¿ƒæ–‡ä»¶

#### 6.1 `database_pricing.py` - æ•°æ®åº“å®šä»·æœåŠ¡

**æ ¸å¿ƒç±»ï¼š** `DatabasePricingService`

**ä¸»è¦åŠŸèƒ½ï¼š**
- ä»æ•°æ®åº“è·å–æ¨¡å‹å®šä»·
- Redis ç¼“å­˜ï¼ˆ24å°æ—¶ TTLï¼‰
- æ”¯æŒ LLM å’Œ TTS æ¨¡å‹

**å…³é”®æ–¹æ³•ï¼š**

1. **è·å–æ¨¡å‹å®šä»·**
```python
pricing_service = DatabasePricingService()

# å•ä¸ªæ¨¡å‹
pricing = pricing_service.get_model_pricing("gpt-4o")
# è¿”å›ï¼š
{
    'input': 0.005,          # è¾“å…¥ä»·æ ¼
    'output': 0.015,         # è¾“å‡ºä»·æ ¼
    'unit': 'å…ƒ/åƒtoken',
    'model_name': 'gpt-4o',
    'capabilities': {...},
    'model_type': 'LLM'
}

# TTS æ¨¡å‹
tts_pricing = pricing_service.get_model_pricing("tts-1")
# è¿”å›ï¼š
{
    'base': 0.015,
    'character': 0.00001,
    'minute': 0.006,
    'unit': 'å…ƒ/åƒå­—ç¬¦',
    'model_name': 'tts-1',
    'model_type': 'TTS'
}
```

2. **æ‰¹é‡è·å–å®šä»·**
```python
all_pricing = pricing_service.get_all_model_pricing()
# è¿”å›ï¼šDict[model_name, pricing_info]
```

3. **ç¼“å­˜ç®¡ç†**
```python
# æ¸…é™¤ç¼“å­˜
pricing_service.clear_cache("gpt-4o")       # å•ä¸ªæ¨¡å‹
pricing_service.clear_cache()               # æ‰€æœ‰æ¨¡å‹

# å¼ºåˆ¶åˆ·æ–°
pricing_service.refresh_model_pricing("gpt-4o")

# é¢„åŠ è½½å¸¸ç”¨æ¨¡å‹
pricing_service.preload_models([
    "gpt-4o", "gpt-4o-mini", "claude-3.5-sonnet"
])
```

**ç¼“å­˜ç­–ç•¥ï¼š**
```python
# ä¸‰çº§ç¼“å­˜
1. å†…å­˜ç¼“å­˜ï¼ˆ_model_cache_missï¼‰- è®°å½•ä¸å­˜åœ¨çš„æ¨¡å‹
2. Redis ç¼“å­˜ - 24å°æ—¶ TTL
3. PostgreSQL - æ•°æ®æº

# æŸ¥è¯¢æµç¨‹
Redis ç¼“å­˜ â†’ å‘½ä¸­ âœ“ è¿”å›
           â†’ æœªå‘½ä¸­ â†“
PostgreSQL â†’ æ‰¾åˆ° â†’ å†™å…¥ Redis â†’ è¿”å›
          â†’ æœªæ‰¾åˆ° â†’ è®°å½•åˆ° _model_cache_miss â†’ è¿”å› None
```

**æ•°æ®åº“è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE model_pricing (
    name VARCHAR(255) PRIMARY KEY,
    type VARCHAR(50),                    -- 'LLM' or 'TTS'
    pricing JSONB,                       -- å®šä»·ä¿¡æ¯
    capabilities JSONB,                  -- èƒ½åŠ›é…ç½®
    deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- LLM å®šä»· JSON ç¤ºä¾‹
{
    "input_token": 0.005,
    "output_token": 0.015,
    "unit": "å…ƒ/åƒtoken"
}

-- TTS å®šä»· JSON ç¤ºä¾‹
{
    "base": 0.015,
    "character": 0.00001,
    "minute": 0.006,
    "unit": "å…ƒ/åƒå­—ç¬¦"
}
```

#### 6.2 `token_counter.py` - Token è®¡æ•°å™¨
ï¼ˆæœªåœ¨æ–‡ä»¶åˆ—è¡¨ä¸­ï¼Œä½†è¢«å¼•ç”¨ï¼‰

**æ ¸å¿ƒç±»ï¼š**
- `TokenCalculator` - Token è®¡ç®—å™¨
- `TokenUsage` - Token ä½¿ç”¨é‡æ•°æ®ç±»
- `TokenStats` - Token ç»Ÿè®¡å™¨ï¼ˆå…¨å±€å•ä¾‹ï¼‰

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
from ..utils.token_counter import token_stats, TokenCalculator, TokenUsage

# è®¡ç®— Token
calculator = TokenCalculator("gpt-4o-mini")
input_tokens = calculator.count_messages_tokens(messages).prompt_tokens

# è®°å½•ä½¿ç”¨
usage = TokenUsage(
    prompt_tokens=input_tokens,
    completion_tokens=output_tokens,
    total_tokens=input_tokens + output_tokens
)

cost_info = calculator.estimate_cost(usage)

# æ·»åŠ åˆ°ç»Ÿè®¡
token_stats.add_usage(
    model="gpt-4o-mini",
    usage=usage,
    cost=cost_info.total_cost,
    metadata={
        "service_type": "chat",
        "user_id": "alice"
    }
)
```

#### 6.3 `token_cost_tracker.py` - Token æˆæœ¬è¿½è¸ªå™¨

**æ ¸å¿ƒç±»ï¼š** `TokenCostTracker`

**ä¸»è¦åŠŸèƒ½ï¼š**
- è·Ÿè¸ª Token ä½¿ç”¨æƒ…å†µ
- ç”Ÿæˆæˆæœ¬æŠ¥å‘Šï¼ˆJSONã€CSVã€Markdownï¼‰
- è®¡ç®—è¿è¡Œæ—¶é•¿å’Œæˆæœ¬

**å…³é”®æ–¹æ³•ï¼š**

1. **è·å–ç»Ÿè®¡æ‘˜è¦**
```python
tracker = TokenCostTracker(report_dir="./token_reports")

summary = tracker.get_summary()
# è¿”å›ï¼š
{
    "tracking_info": {
        "start_time": "2024-01-01 10:00:00",
        "current_time": "2024-01-01 12:30:00",
        "elapsed_seconds": 9000,
        "elapsed_formatted": "2å°æ—¶30åˆ†é’Ÿ0ç§’"
    },
    "total_usage": {
        "prompt_tokens": 12000,
        "completion_tokens": 8000,
        "total_tokens": 20000
    },
    "total_cost": 0.125,
    "model_usage": {
        "gpt-4o-mini": {...},
        "text-embedding-3-small": {...}
    }
}
```

2. **ç”ŸæˆæŠ¥å‘Š**
```python
# ç”Ÿæˆæ‰€æœ‰æ ¼å¼æŠ¥å‘Š
report_paths = tracker.generate_report(format="all")
# è¿”å›ï¼š
{
    "json": "./token_reports/token_report_20240101_120000.json",
    "csv": "./token_reports/token_report_20240101_120000.csv",
    "markdown": "./token_reports/token_report_20240101_120000.md",
    "summary": "./token_reports/token_summary_20240101_120000.json"
}

# ç”Ÿæˆå•ä¸€æ ¼å¼
tracker.generate_report(format="markdown")
```

3. **æ§åˆ¶å°è¾“å‡º**
```python
tracker.print_current_stats()
```
è¾“å‡ºï¼š
```
==================================================
Tokenä½¿ç”¨ç»Ÿè®¡æ‘˜è¦
==================================================
å¼€å§‹æ—¶é—´: 2024-01-01 10:00:00
å½“å‰æ—¶é—´: 2024-01-01 12:30:00
è¿è¡Œæ—¶é•¿: 2å°æ—¶30åˆ†é’Ÿ0ç§’
--------------------------------------------------
æ€»è¾“å…¥Token: 12000
æ€»è¾“å‡ºToken: 8000
æ€»Token: 20000
æ€»æˆæœ¬: $0.125000 USD
--------------------------------------------------
æ¨¡å‹ä½¿ç”¨æƒ…å†µ:
  gpt-4o-mini:
    è¾“å…¥Token: 10000
    è¾“å‡ºToken: 6000
    æ€»Token: 16000
  text-embedding-3-small:
    è¾“å…¥Token: 2000
    è¾“å‡ºToken: 2000
    æ€»Token: 4000
==================================================
```

**å…¨å±€å®ä¾‹ï¼š**
```python
from ..utils.token_cost_tracker import token_cost_tracker

# ä½¿ç”¨å…¨å±€å®ä¾‹
token_cost_tracker.print_current_stats()
token_cost_tracker.generate_report(format="markdown")
```

### ğŸ“Š æˆæœ¬è®¡ç®—å…¬å¼

**LLM æ¨¡å‹ï¼š**
```python
input_cost = (prompt_tokens / 1000) * input_price_per_1k
output_cost = (completion_tokens / 1000) * output_price_per_1k
total_cost = input_cost + output_cost
```

**Embedding æ¨¡å‹ï¼š**
```python
embedding_cost = (total_tokens / 1000) * price_per_1k
```

**TTS æ¨¡å‹ï¼š**
```python
tts_cost = base_price + (characters / 1000) * character_price + (minutes * minute_price)
```

### ğŸ”„ é›†æˆç¤ºä¾‹

**å®Œæ•´æµç¨‹ï¼š**
```python
# 1. è·å–å®šä»·
pricing = pricing_service.get_model_pricing("gpt-4o-mini")

# 2. è°ƒç”¨ LLM
response = openai.chat.completions.create(...)

# 3. è®¡ç®— Token
calculator = TokenCalculator("gpt-4o-mini")
usage = TokenUsage(
    prompt_tokens=response.usage.prompt_tokens,
    completion_tokens=response.usage.completion_tokens,
    total_tokens=response.usage.total_tokens
)

# 4. ä¼°ç®—æˆæœ¬
cost_info = calculator.estimate_cost(usage)

# 5. è®°å½•ç»Ÿè®¡
token_stats.add_usage(
    model="gpt-4o-mini",
    usage=usage,
    cost=cost_info.total_cost,
    metadata={"user_id": "alice"}
)

# 6. ç”ŸæˆæŠ¥å‘Š
token_cost_tracker.generate_report(format="all")
```

### ğŸ”‘ å…³é”®è®¾è®¡æ¨¡å¼
1. **å•ä¾‹æ¨¡å¼**ï¼šå…¨å±€ `pricing_service` å’Œ `token_cost_tracker`
2. **ç­–ç•¥æ¨¡å¼**ï¼šä¸åŒæ¨¡å‹ç±»å‹çš„å®šä»·ç­–ç•¥
3. **è£…é¥°å™¨æ¨¡å¼**ï¼šè‡ªåŠ¨ç»Ÿè®¡ Token ä½¿ç”¨

---

## ğŸ”— æ¨¡å—é—´ä¾èµ–å…³ç³»

```mermaid
graph TD
    A[multi_user] --> B[database]
    C[emotion_system] --> B
    C --> D[important]
    D --> E[utils]
    F[tools] --> D
    F --> E

    A -->|ç”¨æˆ·çŠ¶æ€| G[Agent]
    C -->|æƒ…ç»ªæç¤º| G
    D -->|è®°å¿†æ£€ç´¢| G
    F -->|å·¥å…·è°ƒç”¨| G
```

**ä¾èµ–è¯´æ˜ï¼š**
- **multi_user** â†’ **database**ï¼šç”¨æˆ·ä¼šè¯å­˜å‚¨
- **emotion_system** â†’ **database**ï¼šå¥½æ„Ÿåº¦æŒä¹…åŒ–
- **emotion_system** â†’ **important**ï¼šæƒ…ç»ªç›¸å…³è®°å¿†
- **important** â†’ **utils**ï¼šToken ç»Ÿè®¡
- **tools** â†’ **important**ï¼šè®°å¿†æœç´¢å·¥å…·
- **tools** â†’ **utils**ï¼šæˆæœ¬è¿½è¸ª

---

## ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—

### 1. åˆå§‹åŒ–æ•°æ®åº“
```python
# PostgreSQL
from src.ling_engine.database.pgsql.init_database import init_database
init_database()

# Qdrant
from src.ling_engine.important.memories import init_db
init_db()
```

### 2. å¯åŠ¨ Agent
```python
from src.ling_engine.multi_user import UserSessionManager
from src.ling_engine.emotion_system import EmotionManager, EmotionalBasicMemoryAgent
from src.ling_engine.tools import tool_manager

# ç”¨æˆ·ä¼šè¯ç®¡ç†
session_manager = UserSessionManager()

# æƒ…ç»ªç®¡ç†
emotion_manager = EmotionManager(affinity_storage, llm_provider)

# å·¥å…·ç®¡ç†
tool_manager.initialize()
tools = tool_manager.get_langchain_tools()

# åˆ›å»º Agent
agent = EmotionalBasicMemoryAgent(
    llm=llm,
    system=system_prompt,
    live2d_model=live2d_model,
    emotion_manager=emotion_manager
)
```

### 3. å¤„ç†ç”¨æˆ·è¯·æ±‚
```python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()

    # æå–ç”¨æˆ·èº«ä»½
    user_id = await session_manager.extract_user_identity(websocket)
    client_uid = generate_client_uid()

    # æ³¨å†Œè¿æ¥
    user_state = session_manager.register_connection(
        websocket, client_uid, user_id
    )

    # è®¾ç½®æƒ…ç»ªç®¡ç†å™¨
    emotion_manager.set_websocket(websocket)
    emotion_manager.set_live2d_model(live2d_model)

    # è®¾ç½® Agent è®°å¿†
    agent.set_memory_from_history(conf_uid, history_uid)

    # å¤„ç†æ¶ˆæ¯
    async for message in websocket.iter_text():
        response = await agent.chat(message)
        await websocket.send_text(response)
```

### 4. æŸ¥çœ‹ç»Ÿè®¡æŠ¥å‘Š
```python
from src.ling_engine.utils.token_cost_tracker import token_cost_tracker

# æ‰“å°ç»Ÿè®¡
token_cost_tracker.print_current_stats()

# ç”ŸæˆæŠ¥å‘Š
reports = token_cost_tracker.generate_report(format="all")
print(f"Reports generated: {reports}")
```

---

## ğŸ“‹ ç¯å¢ƒå˜é‡é…ç½®æ¸…å•

### æ•°æ®åº“é…ç½®
```bash
# PostgreSQL
PGHOST=localhost
PGPORT=5432
PGUSER=postgres
PGPASSWORD=your_password
PGDATABASE=vtuber_chat_db

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_NAMESPACE=vtuber
```

### LLM é…ç½®
```bash
# OpenAI
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o-mini
OPENAI_EMBEDDING_MODEL=text-embedding-3-small
OPENAI_EMBEDDING_MODEL_DIMS=1536
```

### å‘é‡æ•°æ®åº“é…ç½®
```bash
# Qdrant
QDRANT_URL=http://localhost:6333
COLLECTION_NAME=openmemory

# Neo4j
NEO4J_URI=bolt://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=12345678
```

---

## âš ï¸ å¸¸è§é—®é¢˜ä¸æ³¨æ„äº‹é¡¹

### 1. ç”¨æˆ·éš”ç¦»é—®é¢˜
**é—®é¢˜ï¼š** å¤šç”¨æˆ·è®°å¿†æ··æ·†
**è§£å†³ï¼š**
```python
# æ‰€æœ‰æ“ä½œå¿…é¡»ä¼ å…¥ user_id
save_memory(content, user_id=user_id)
search_similar_memories(query, user_id=user_id)

# ç¦æ­¢ä½¿ç”¨é»˜è®¤ç”¨æˆ·ID
if user_id == "default_user":
    logger.error("æ‹’ç»ä½¿ç”¨é»˜è®¤ç”¨æˆ·ID")
    return []
```

### 2. å¥½æ„Ÿåº¦æ›´æ–°æ—¶æœº
**é—®é¢˜ï¼š** AI å›å¤ä¹Ÿä¼šå½±å“å¥½æ„Ÿåº¦å—ï¼Ÿ
**å½“å‰è®¾è®¡ï¼š** åªæœ‰ç”¨æˆ·æ¶ˆæ¯å½±å“å¥½æ„Ÿåº¦ï¼ˆ`role="human"`ï¼‰

```python
# emotional_agent.py
if self._character_id and self._user_id:
    await self._emotion_manager.update_affinity(
        self._character_id,
        self._user_id,
        user_text,
        "human"  # åªå¤„ç†ç”¨æˆ·æ¶ˆæ¯
    )
```

### 3. ç¼“å­˜ä¸€è‡´æ€§
**é—®é¢˜ï¼š** Redis ç¼“å­˜ä¸æ•°æ®åº“ä¸ä¸€è‡´
**è§£å†³ï¼š**
```python
# å¼ºåˆ¶åˆ·æ–°
pricing_service.refresh_model_pricing(model_name)

# æ¸…é™¤ç¼“å­˜
pricing_service.clear_cache()
```

### 4. è®°å¿†æ£€ç´¢æ€§èƒ½
**é—®é¢˜ï¼š** å¤§é‡è®°å¿†æ—¶æ£€ç´¢æ…¢
**ä¼˜åŒ–ï¼š**
- é™åˆ¶ Neo4j æŸ¥è¯¢çš„ä¸‰å…ƒç»„æ•°é‡ï¼ˆ`max_triples_to_check = 15`ï¼‰
- æŒ‰æ¯”ä¾‹åˆ†é… Qdrant/Neo4j ç»“æœï¼ˆ60%/40%ï¼‰
- ä½¿ç”¨ç»¼åˆæ’åºæé«˜ç›¸å…³æ€§

### 5. Token ç»Ÿè®¡ä¸¢å¤±
**é—®é¢˜ï¼š** æŸäº›è°ƒç”¨æœªç»Ÿè®¡
**æ£€æŸ¥ï¼š**
```python
# ç¡®ä¿æ‰€æœ‰ LLM/Embedding è°ƒç”¨éƒ½æ·»åŠ ç»Ÿè®¡
token_stats.add_usage(
    model=model_name,
    usage=usage,
    cost=cost,
    metadata={"service_type": "..."}
)
```

---

## ğŸ“š æ‰©å±•å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„å¥½æ„Ÿåº¦ç­‰çº§
```python
# emotion_manager.py - EmotionConfig
self.affinity_levels["obsessed"] = {
    "threshold": 95,
    "prompt": "...",
    "personality_traits": [...]
}
```

### æ·»åŠ æ–°çš„è®°å¿†åˆ†ç±»
```python
# important.py - process_content
# ä¿®æ”¹ promptï¼Œæ·»åŠ æ–°çš„åˆ†ç±»æ ‡ç­¾
# ä¾‹å¦‚ï¼š'å­¦ä¹ 'ã€'å·¥ä½œ'ã€'å¨±ä¹' ç­‰
```

### æ·»åŠ æ–°çš„æ•°æ®åº“è¡¨
```python
# database/pgsql/database_manager.py
class NewTableManager:
    def __init__(self, db_manager: DatabaseManager):
        self.db_manager = db_manager

    def create_record(self, data):
        # å®ç° CRUD é€»è¾‘
        pass
```

### é›†æˆæ–°çš„ LLM æä¾›å•†
```python
# utils/database_pricing.py
# 1. åœ¨æ•°æ®åº“æ·»åŠ æ–°æ¨¡å‹å®šä»·
INSERT INTO model_pricing (name, type, pricing) VALUES (
    'new-model',
    'LLM',
    '{"input_token": 0.001, "output_token": 0.002}'::jsonb
);

# 2. é¢„åŠ è½½æ¨¡å‹
pricing_service.preload_models(["new-model"])
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### å¯ç”¨è¯¦ç»†æ—¥å¿—
```python
import logging
logging.basicConfig(level=logging.DEBUG)

# æˆ–ä½¿ç”¨ loguru
from loguru import logger
logger.add("debug.log", level="DEBUG")
```

### æŸ¥çœ‹å¥½æ„Ÿåº¦å˜åŒ–
```python
# emotion_manager.py å·²å†…ç½®æ§åˆ¶å°è¾“å‡º
# æŸ¥çœ‹ _print_affinity_change_console æ–¹æ³•
```

### æ£€æŸ¥è®°å¿†å­˜å‚¨
```python
from src.ling_engine.important.memories import list_all_memories_simple

memories = list_all_memories_simple(user_id="alice", limit=10)
for mem in memories:
    print(f"{mem['created_at']}: {mem['summary']}")
```

### éªŒè¯ Token ç»Ÿè®¡
```python
from src.ling_engine.utils.token_counter import token_stats

summary = token_stats.get_summary()
print(f"Total cost: ${summary['total_cost']:.6f}")
print(f"Total tokens: {summary['total_usage'].total_tokens}")
```

---

---

## é™„å½•ï¼šæ–‡ä»¶ç´¢å¼•

### Multi_User æ¨¡å—
- `user_session_manager.py:24` - `extract_user_identity` æ–¹æ³•
- `user_session_manager.py:63` - `register_connection` æ–¹æ³•
- `user_state.py:126` - `create_session` æ–¹æ³•
- `user_aware_agent.py:28` - `switch_to_user` æ–¹æ³•

### Tools æ¨¡å—
- `base_tool.py:27` - `execute` æŠ½è±¡æ–¹æ³•
- `base_tool.py:68` - `create_langchain_tool` æ–¹æ³•
- `tool_manager.py:38` - `get_all_tools` æ–¹æ³•

### Database æ¨¡å—
- `database_manager.py:60` - `SnowflakeIDGenerator.generate_id`
- `database_manager.py:149` - `ChatSessionManager.create_session`
- `database_manager.py:356` - `ChatMessageManager.add_message`
- `redis_manager.py:83` - `set_json` æ–¹æ³•

### Emotion_System æ¨¡å—
- `emotion_manager.py:225` - `update_affinity` æ–¹æ³•
- `emotion_manager.py:428` - `get_emotion_prompt` æ–¹æ³•
- `emotion_manager.py:480` - `_update_live2d_expression` æ–¹æ³•
- `emotional_agent.py:34` - `set_memory_from_history` æ–¹æ³•

### Important æ¨¡å—
- `important.py:15` - `process_content` å‡½æ•°
- `memories.py:217` - `save_memory` å‡½æ•°
- `memories.py:446` - `search_similar_memories` å‡½æ•°
- `memories.py:889` - `get_user_knowledge_graph` å‡½æ•°

### Utils æ¨¡å—
- `database_pricing.py:47` - `get_model_pricing` æ–¹æ³•
- `database_pricing.py:246` - `get_all_model_pricing` æ–¹æ³•
- `token_cost_tracker.py:44` - `get_summary` æ–¹æ³•
- `token_cost_tracker.py:71` - `generate_report` æ–¹æ³•

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0
**æœ€åæ›´æ–°ï¼š** 2024-10-17